<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->

<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description"
	content="Introducing Lollipop, a sweet new take on Android.">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Publish live Broadcast to Facebook, Youtube and Periscope
	with WebRTC</title>

<!-- Page styles -->
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet"
	href="https://code.getmdl.io/1.3.0/material.min.css">
<link rel="stylesheet" href="styles.css">
<style>
#view-source {
	position: fixed;
	display: block;
	right: 0;
	bottom: 0;
	margin-right: 40px;
	margin-bottom: 40px;
	z-index: 900;
}
</style>
</head>

<body onunload="Stop()">
	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">

		<div
			class="android-header mdl-layout__header mdl-layout__header--waterfall">
			<div class="mdl-layout__header-row">
				<span class="android-title mdl-layout-title logo-font"
					style="font-size: 25px; color: #444;"> <img
					class="android-logo-image" src="images/WebRTC.png"
					style="vertical-align: bottom;"> Publish Live to Social Media
				</span>
				<!-- Add spacer, to align navigation to the right in desktop -->
				<div class="android-header-spacer mdl-layout-spacer"></div>
				<!-- Navigation -->
				<div class="android-navigation-container">
					<nav class="android-navigation mdl-navigation">
						<a class="mdl-navigation__link mdl-typography--text-uppercase"
							href="http://antmedia.io/#contact">Report an Issue</a>
					</nav>
				</div>
				<span class="android-mobile-title mdl-layout-title"> <!--
            <img class="android-logo-image" src="images/android-logo.png">
          -->
				</span>

			</div>
		</div>

		<div class="android-content mdl-layout__content">
			<a name="top"></a>

			<div class="android-be-together-section mdl-typography--text-center"
				style="padding-top: 20px">

				<div class="mdl-card mdl-shadow--4dp"
					style="max-width: 640px; width: 80%; margin: auto;">
					<video id="localVideo" autoplay muted width="100%"></video>

					<p>
						<span class="label label-danger" id="broadcastingInfo"
							style="display: none">Broadcasting</span>
					</p>
					<div>
						<div class="input-group col-sm-offset-2 col-sm-8">
							<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
								for="facebook-checkbox"
								style="width: inherit; margin-left: 36px;"> <input
								type="checkbox" id="facebook-checkbox"
								onchange="fetchDeviceAuthParameters('facebook')"
								class="mdl-checkbox__input"> <span
								class="mdl-checkbox__label">Publish to Facebook</span>
							</label> <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
								for="youtube-checkbox"
								style="width: inherit; margin-left: 36px;"> <input
								type="checkbox" id="youtube-checkbox"
								onchange="fetchDeviceAuthParameters('youtube')"
								class="mdl-checkbox__input"> <span
								class="mdl-checkbox__label">Publish to Youtube</span>
							</label> <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
								for="periscope-checkbox"
								style="width: inherit; margin-left: 36px;"> <input
								type="checkbox" id="periscope-checkbox"
								onchange="fetchDeviceAuthParameters('periscope')"
								class="mdl-checkbox__input"> <span
								class="mdl-checkbox__label">Publish to Periscope</span>
							</label> <br /> <span>
								<div
									class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
									<input class="mdl-textfield__input" type="text" id="streamName"
										value="hi"> <label class="mdl-textfield__label"
										for="streamName">Stream name</label>
								</div>


								<button onclick="Start()" id="start_publishing_button"
									class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">Start
									Publishing</button>
							</span>


						</div>
					</div>



				</div>
			</div>

			<footer class="android-footer mdl-mega-footer">
				<div class="mdl-mega-footer--top-section"></div>

				<div class="mdl-mega-footer--middle-section">
					<p class="mdl-typography--font-light">Authentication parameters
						are not stored. They will be discarded when you close browser</p>
				</div>

				<div class="mdl-mega-footer--bottom-section">
					<a class="android-link mdl-typography--font-light"
						href="http://antmedia.io/">Ant Media</a> <a
						class="android-link mdl-typography--font-light"
						href="http://antmedia.io/#contact">Report an Issue</a>
				</div>

			</footer>
		</div>
	</div>
	<dialog class="mdl-dialog" id="authenticateDialog">
	<h4 class="mdl-dialog__title">2 Steps</h4>
	<div class="mdl-dialog__content">
		<ol>
			<li>Copy this code:
				<div style="display: inline; font-weight: bold" id="user_code"></div>
			</li>
			<li>Enter the code to this url:
				<div style="display: inline; font-weight: bold"
					id="verification_url"></div>
			</li>
		</ol>

	</div>
	<div class="mdl-dialog__actions">
		<button type="button" class="mdl-button ok">OK</button>
		<button type="button" class="mdl-button close">Cancel</button>
	</div>
	</dialog>
	<dialog class="mdl-dialog" id="loadingDialog">
	<div id="loading_message"></div>
	<div id="p2"
		class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
	</dialog>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/dialog-polyfill/0.4.2/dialog-polyfill.min.js"></script>
	<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
	<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="js/websocket_webrtc.js"></script>

	<script>
    function detectmob() { 
	  if( navigator.userAgent.match(/Android/i)
	  || navigator.userAgent.match(/webOS/i)
	  || navigator.userAgent.match(/iPhone/i)
	  || navigator.userAgent.match(/iPad/i)
	  || navigator.userAgent.match(/iPod/i)
	  || navigator.userAgent.match(/BlackBerry/i)
	  || navigator.userAgent.match(/Windows Phone/i)
	  ){
	     return true;
	   }
	  else {
	     return false;
	   }
	 }
  
    function isBrowserCompatible() {
      if ((navigator.userAgent.indexOf("Opera") || navigator.userAgent.indexOf('OPR')) != -1) {
        return true;
      }
      else if (navigator.userAgent.indexOf("Chrome") != -1) {
        return true;
      }
      else if (navigator.userAgent.indexOf("Safari") != -1) {
        return false;
      }
      else if (navigator.userAgent.indexOf("Firefox") != -1) {
        return true;
      }
      else if ((navigator.userAgent.indexOf("MSIE") != -1) || (!!document.documentMode == true)) //IF IE > 10
      {
        return false;
      }
      else {
        return false;
      }
    }

    var dialog = document.querySelector('#authenticateDialog');
    var loadingDialog = document.querySelector('#loadingDialog');
    var loadingMessage = document.querySelector("#loading_message");

    if (!dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
      dialogPolyfill.registerDialog(loadingDialog);
    }

    var serviceNameActive;

    var facebookAuthenticated = false;
    var youtubeAuthenticated = false;
    var periscopeAuthenticated = false;

    dialog.querySelector('.ok').addEventListener('click', function () {
      checkCount = 0;
      dialog.close();
      askDeviceAuthStatus(serviceNameActive, true);
    });
    dialog.querySelector('.close').addEventListener('click', function () {
      checkCount = 0;
      dialog.close();
    });



    var localStream;

    /* Yerel ve Uzak uç birimler arasında bağlantı kurmamızı
     sağlayacak nesne
     */
    var remotePeerConnection;

    /* videoları çalacak nesneler
     */

    var localVideo = document.getElementById("localVideo");

    var streamNameBox = document.getElementById("streamName");



    function startAnimation() {

      $("#broadcastingInfo").fadeIn(800, function () {
        $("#broadcastingInfo").fadeOut(800, function () {
          if (remotePeerConnection.signalingState != "closed") {
            startAnimation();
          }
        });
      });

    }



    function showLoader(text) {
      try {
        if (typeof text == "undefined") {
          text = "";
        }
        loadingMessage.innerHTML = text;
        loadingDialog.showModal();
      }
      catch (e) {

      }
    }

    function hideLoader() {
      loadingDialog.close();
    }

    function fetchDeviceAuthParameters(serviceName) {
      if ($("#" + serviceName + "-checkbox").is(":checked")) {
        var authenticated = false;
        if (serviceName == "facebook") {
          authenticated = facebookAuthenticated;
        }
        else if (serviceName == "youtube") {
          authenticated = youtubeAuthenticated;
        }
        else if (serviceName == "periscope") {
          authenticated = periscopeAuthenticated;
        }
        if (!authenticated) {
          $("#" + serviceName + "-checkbox").prop("checked", false);
          showLoader();
          serviceNameActive = serviceName;
          fetch('rest/broadcast/getDeviceAuthParameters/' + serviceName,
            {
              method: 'post',
              headers: {
                "Content-type": "application/json"
              },
              credentials: 'include'
            }
          ).then(
            function (response) {
              if (response.status !== 200) {
                console.log('Looks like there was a problem. Status Code: ' +
                  response.status);
                return;
              }

              hideLoader();
              // Examine the text in the response
              response.json().then(function (data) {
                //console.log(data.device_code);
                document.getElementById("user_code").innerHTML = data.user_code;
                var verification_url = data.verification_url;
                if (data.verification_url.indexOf("http") == -1) {
                  verification_url = "http://" + data.verification_url;
                }
                document.getElementById("verification_url").innerHTML = '<a target="blank" href="' + verification_url + '">' + data.verification_url + '</a>';
                dialog.showModal();

              });
            }
            )
            .catch(function (err) {
              console.log('Fetch Error :-S', err);
            });
        }
      }
      else {
        //not checked
      }

    }

    function askDeviceAuthStatus(serviceName, askagain) {
      showLoader();
      fetch('rest/broadcast/checkDeviceAuthStatus/' + serviceName,
        {
          method: 'post',
          headers: {
            "Content-type": "application/json"
          },
          credentials: 'include'
        }
      ).then(
        function (response) {
          if (response.status !== 200) {
            console.log('Looks like there was a problem. Status Code: ' +
              response.status);
            return;
          }

          // Examine the text in the response
          response.json().then(function (data) {
            console.log("status of service auth " + data.success);
            if (data.success == true) {
              hideLoader();
              if (serviceName == "facebook") {
                facebookAuthenticated = true;
                document.getElementById("facebook-checkbox").parentNode.MaterialCheckbox.check();
              }
              else if (serviceName == "youtube") {
                youtubeAuthenticated = true;
                document.getElementById("youtube-checkbox").parentNode.MaterialCheckbox.check();
              }
              else if (serviceName == "periscope") {
                periscopeEnabled = true;
                periscopeAuthenticated = true;
                document.getElementById("periscope-checkbox").parentNode.MaterialCheckbox.check();
              }
            }
            else {
              if (askagain) {
                console.log("not authenticated");
                setTimeout(askDeviceAuthStatus, 5000, serviceNameActive, true);
              }
              else {
                hideLoader();
              }
            }

          });

        }
        )
        .catch(function (err) {
          console.log('Fetch Error :-S', err);
        });
    }


    $(function () {

      if (isBrowserCompatible()) {
    	  if (!detectmob()) {
		        navigator.getUserMedia({
		          video: true,
		          audio: true
		        }, gotStream, function (error) {
		         
		          $(".mdl-button").prop("disabled", true);
		          $("input[type=checkbox]").prop("disabled", true);
		          alert("Please let browser access the camera and microphone");
		          console.log(" getUserMedia hatası: ", error);
		        });
    	  }
    	  else {
    		  alert("Please try this app on Desktop with Chrome, Firefox or Opera Browser");
    		  $(".mdl-button").prop("disabled", true);
    	        $("input[type=checkbox]").prop("disabled", true);
    	  }
      }
      else {
    	alert("Please try this app on Desktop with Chrome, Firefox or Opera Browser");
        $(".mdl-button").prop("disabled", true);
        $("input[type=checkbox]").prop("disabled", true);

      }

    });
  </script>

	<script>
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-93263926-2', 'auto');
    ga('send', 'pageview');

  </script>
</body>

</html>